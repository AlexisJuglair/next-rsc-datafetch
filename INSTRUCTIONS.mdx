# useActionState : Validation Serveur

### 💡 Comprendre `useActionState` et la validation Serveur

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Comme il est courant d’utiliser les serveurs action avec un formulaire, il y a un nouveau `Hook React` assez utile pour gérer l’état du formulaire : **`useActionState`**

**`useActionState`** est un Hook qui vous permet de mettre à jour l'état en fonction du résultat d'une action de formulaire.

```tsx
import {useActionState} from 'react'
import {action} from './actions.js'

function MyComponent() {
  const [state, formAction] = useActionState(action, null)
  // ...
  return <form action={formAction}>{/* ... */}</form>
}
```

Note : l’action prend 2 paramètres : un `state` et le `FormData`

Ce Hook va de pair avec `useformStatus` qui permet d’obtenir le statut du formulaire.

```tsx
//SI
type ActionStateType = {success: boolean}
const [state, formAction] = useActionState(action, {success: false} )

//ALORS action aura 2 paramètres
export async function onSubmitAction(
  prevState: ActionStateType ,
  data: FormData
  ...
```

```tsx
function Submit() {
  const status = useFormStatus()
  return <button disabled={status.pending}>Submit</button>
}

export default function App() {
  return (
    <form action={action}>
      <Submit />
    </form>
  )
}
```

📑 Le lien vers la doc [https://react.dev/reference/react/useActionState#usage](https://react.dev/reference/react/useActionState#usage)

## Exercice

Dans les exercices précédents, `React Hook Form` s'occupait de gérer l’état et soumettre le formulaire à l’action. Nous voulons maintenant profiter de `useActionState` et `useFormStatus` de React nativement.

👨‍✈️ Hugo, le Chef de projet, te demande de désactiver la validation `Zod` client car non Safe et de l’ajouter côté server action.

Nous avons supprimé tous les liens à `React Hook Form` pour simplifier l’exercice pour revenir à un formulaire non contrôlé.

```tsx
<form ref={formRef} className="gap-2 space-y-4">
  <Label>Product title</Label>
  <Input placeholder="ex : Iphone" name="title" />
  <Label>Product title</Label>
  <Input type="number" placeholder="199" name="price" />
  <Label>Product title</Label>
  <Textarea placeholder="Product description" name="description" />
  <Label>Product title</Label>
  <Select name="category">
    <SelectTrigger>
      <SelectValue placeholder="Choisir une catégorie" />
    </SelectTrigger>

    <SelectContent>
      {categories.map((category) => (
        <SelectItem key={category} value={category}>
          {category}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  <Label>Product title</Label>
  <Input type="number" placeholder="Product quantity" name="quantity" />
  <div className="flex gap-2">
    <Button size="sm" type="submit">
      Save
    </Button>
    <Button size="sm" variant="outline">
      Cancel
    </Button>
  </div>
</form>
```

**🐶** Dans cet exercice, tu vas devoir adapter le formulaire en soumettant via `useActionState` .

🐶 Tu vas également devoir faire une validation côté serveur avec `Zod` et afficher un message d’erreur (`toast`) dans le `form`

Pense à reset le formulaire après ajout.

Fichiers

- `exercises/shop-admin/form/use-action-state.tsx`
- `exercises/shop-admin/actions.tsx`

## Bonus

### 1. 🚀 Supprimer des champs de la validation Zod

Nous envoyons bien les données du formulaire au server action, cependant, la validation est trop stricte. Beaucoup de champs ne sont pas dans le `FormData` comme l’`id`, `updatedAt` etc … Ils pourraient être ajoutés en champs `hidden` mais nous ne voulons pas avoir à gérer cela dans le `form`.

```tsx
<form action={formAction} ref={formRef} className="gap-2 space-y-4">
      <input type="hidden" name="id" value={product?.id} />
```

Nous allons rendre optionnels certains champs de la validation (sans changer le schéma original `formSchema`). Pour cela, nous allons utiliser `zod.partial`

📑 [https://zod.dev/?id=partial](https://zod.dev/?id=partial)

Exemple qui rend `email` optionnel sur un type `user`

```tsx
const optionalEmail = user.partial({
  email: true,
})
```

🐶 Dans cet exercice, tu vas devoir créer un nouveau type `formSchemaLight` à partir de `formSchema` qui rend les champs `id` et `createdAt` optionnels.

Fichiers

- `exercises/shop-admin/actions.tsx`

### 2. 🚀 useFormStatus

👨‍✈️ Hugo, le chef de projet, demande de désactiver le bouton `Save` lors que le soumission du formulaire.

🐶 Utilise le Hook `useFormStatus` pour gérer le statut `pending` du formulaire.

**🤖** `const status = useFormStatus()`

Note : `useFormStatus` fonctionne dans un composant `Children` où se situe le `useActionState` .

- Crée un composant `<Buttons />` contentant les 2 boutons et gérant le statut.

Fichiers

- `exercises/shop-admin/form/use-action-state.tsx`

## Aller plus loin

📑 Le lien vers la doc [https://www.w3schools.com/html/html_css.asp](https://www.w3schools.com/html/html_css.asp)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=03.RSC%20Data%20fetch&entry.533578441=08%20useActionState%20Server%20validation).
