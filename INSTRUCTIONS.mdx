# Form : Validation Client / Serveur

### 💡 Comprendre la validation Client Serveur avec RHF

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Nous avons vu la validation des champs côté client avec `React Hook Form` et `Zod`. Cela fonctionne bien mais en désactivant `JavaScript` dans le navigateur, quelqu’un pourrait soumettre n’importe quelle donnée. Voilà pourquoi il est impératif d’avoir une validation côté serveur. C’est aussi ce que nous avons fait avec un formulaire et `useActionState`. Mais la validation serveur prend du temps, ce qui rend l’expérience utilisateur moins agréable.

Nous allons ici combiner les 2 approches.

- `React Hook Form`/ `Zod` pour la validation client.
- `useActionState`/ Validation `Zod` server.
- Et nous allons implémenter des règles spécifiques et gérer des erreurs côté serveur.

Avec RHF, il est possible de spécifier manuellement les erreurs comme cela. Exemple sur le champs `title` :

```tsx
form.setError('title', {type: 'manual', message: 'le titre nest pas bon'})
```

Nous allons donc devoir retourner 2 types d’erreurs :

- Les erreurs liées aux champs : Une liste d’erreurs avec message du serveur action.
- Les erreurs non liées aux champs.

```tsx
type ValidationError = {
  field: keyof FormSchemaType
  message: string
}

export type FormState = {
  success: boolean
  errors?: ValidationError[]
  message?: string
}
export async function onSubmitAction(
  prevState: FormState,
  data: FormData
```

## Exercice

Le point de départ de l’exercice est le formulaire `React Hook Form` avec la validation client de l’exercice précédent, avec un appel server action `persistProduct`.

```tsx
//rappel de la signature de l'action
type FormStateSimple = {error: boolean; message: string}

export async function onSubmitAction(
  prevState: FormStateSimple,
  data: FormData
```

**🐶** Dans un premier temps, adapte l’action en utilisant les nouveaux types `ValidationError` et `FormState` dans l’action. Retourne toutes les erreurs `zod` grâce à :

```tsx
if (!parsed.success) {
parsed.error.errors.map(....
```

🐶 Dans un second temps, adapte le formulaire pour gérer ces erreurs.

Fichiers

- `exercise/shop-admin/form/use-action-state.tsx`
- `exercise/shop-admin/action.tsx`

## Bonus

### 1. 🚀 Gestion du isPending (useFormStatus)

Dans les exercices précédents, nous avons vu que `useActionState` peut s’utiliser de pair avec `useFormStatus`. Cela nous permettait de désactiver le bouton durant la soumission

```tsx
const Buttons = () => {
  const status = useFormStatus()
  return (
    <>
      <Button size="sm" type="submit" disabled={status.pending}>
        Save
      </Button>
      <Button size="sm" variant="outline">
        Cancel
      </Button>
    </>
  )
}
```

Essaie d’utiliser cette méthode et constate que cela ne fonctionne pas. Cela est dû en fait que le formulaire n’est pas géré de manière non contrôlée avec une `action` (comme exercice précédent)

```tsx
<form
  action={formAction}
>
```

**🐶** Dans cet exercice, tu vas devoir gérer l’état de soumission avec un state `isPending`

```tsx
const [isPending, setIsPending] = React.useState(false)
```

- Lors de la soumission : `setIsPending(true)`
- Lors de la mise à jour du state de `useActionForm` → `setIsPending(false)`
- Utilise ce state pour `disable` le buton

Fichiers

- `exercise/shop-admin/form/use-action-state.tsx`

### 2. 🚀 Gérer des erreurs custom server

👨‍✈️ Hugo, le chef de projet, te demande maintenant de gérer 2 nouvelles erreurs custom.

1. Hugo te demande de valider que le champ `‘title’` ne contient pas 2 espaces.

   **🤖** Utilise le code ci dessous :

   ```tsx
   **data.get('title')?.toString().includes('  ')**
   ```

2. Hugo te demande d’interdire l’insertion en double des données en base de données. Pour cela il te fournit une fonction `getProductByName` qui récupère un produit en fonction de son nom :

```tsx
const prod = await getProductByName(data.get('title')?.toString() ?? '')
if (prod) { ...
```

- 🐶 Si le nom du produit contient 2 espaces consécutifs, retourne un message d’erreur sur le champ `‘title’` `‘Custom server error : Title must not contain 2 spaces’`
- 🐶 Si le produit existe déjà, retourne un message d’erreur sur le champ `title` `‘Product al0ready exists’`

Fichiers

- `exercise/shop-admin/action.tsx`

## Aller plus loin

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20PRO&entry.1430994900=03.RSC%20Data%20fetch&entry.533578441=09%20Validation%20Client%20Server).
